{% extends 'base.html' %}
{% block title %}Pemasok - E-Commerce{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-2 mb-md-0">Pemasok</h1>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
        <i class="fas fa-plus me-1"></i>Tambah Pemasok Baru
      </button>
      <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-file-import me-1"></i>Impor</button>
      <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-file-export me-1"></i>Ekspor</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nama</th>
              <th>Kontak</th>
              <th>Email</th>
              <th>Kota</th>
              <th>Alamat</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% if suppliers %}
              {% for supplier in suppliers %}
              <tr>
                <td>{{ supplier.id }}</td>
                <td>{{ supplier.name }}</td>
                <td>{{ supplier.contact }}</td>
                <td>{{ supplier.email }}</td>
                <td>{{ supplier.city }}</td>
                <td>{{ supplier.address }}</td>
                <td>
                  <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm edit-btn" data-id="{{ supplier.id }}" data-name="{{ supplier.name }}" data-contact="{{ supplier.contact }}" data-email="{{ supplier.email }}" data-city="{{ supplier.city }}" data-address="{{ supplier.address }}">
                      <i class="fas fa-pen me-1"></i>Edit
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-btn" data-id="{{ supplier.id }}" data-name="{{ supplier.name }}">
                      <i class="fas fa-trash me-1"></i>Hapus
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted">Tidak ada data pemasok</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">Menampilkan {{ suppliers|length }} data</div>
        <nav aria-label="Pagination">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item disabled"><span class="page-link">«</span></li>
            <li class="page-item active"><span class="page-link">1</span></li>
            <li class="page-item disabled"><span class="page-link">»</span></li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Add Supplier -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSupplierModalLabel">Tambah Pemasok Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addSupplierForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="id_supplier" class="form-label">ID</label>
              <input type="text" class="form-control" id="id_supplier" name="id" required>
            </div>
            <div class="col-md-6">
              <label for="name_supplier" class="form-label">Nama</label>
              <input type="text" class="form-control" id="name_supplier" name="name" required>
            </div>
            <div class="col-md-6">
              <label for="contact_supplier" class="form-label">Kontak</label>
              <input type="text" class="form-control" id="contact_supplier" name="contact" required>
            </div>
            <div class="col-md-6">
              <label for="email_supplier" class="form-label">Email</label>
              <input type="email" class="form-control" id="email_supplier" name="email" required>
            </div>
            <div class="col-md-6">
              <label for="city_supplier" class="form-label">Kota</label>
              <input type="text" class="form-control" id="city_supplier" name="city" required>
            </div>
            <div class="col-md-12">
              <label for="address_supplier" class="form-label">Alamat Pemasok</label>
              <textarea class="form-control" id="address_supplier" name="address" rows="3" required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for Edit Supplier -->
<div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSupplierModalLabel">Edit Pemasok</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editSupplierForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="edit_id_supplier" class="form-label">ID</label>
              <input type="text" class="form-control" id="edit_id_supplier" name="id" readonly>
            </div>
            <div class="col-md-6">
              <label for="edit_name_supplier" class="form-label">Nama</label>
              <input type="text" class="form-control" id="edit_name_supplier" name="name" required>
            </div>
            <div class="col-md-6">
              <label for="edit_contact_supplier" class="form-label">Kontak</label>
              <input type="text" class="form-control" id="edit_contact_supplier" name="contact" required>
            </div>
            <div class="col-md-6">
              <label for="edit_email_supplier" class="form-label">Email</label>
              <input type="email" class="form-control" id="edit_email_supplier" name="email" required>
            </div>
            <div class="col-md-6">
              <label for="edit_city_supplier" class="form-label">Kota</label>
              <input type="text" class="form-control" id="edit_city_supplier" name="city" required>
            </div>
            <div class="col-md-12">
              <label for="edit_address_supplier" class="form-label">Alamat Pemasok</label>
              <textarea class="form-control" id="edit_address_supplier" name="address" rows="3" required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for Delete Confirmation -->
<div class="modal fade" id="deleteSupplierModal" tabindex="-1" aria-labelledby="deleteSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteSupplierModalLabel">Konfirmasi Hapus</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus pemasok <strong id="delete_supplier_name"></strong> dengan ID <strong id="delete_supplier_id"></strong>?</p>
        <p class="text-danger">Tindakan ini tidak dapat dibatalkan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteSupplierBtn">Hapus</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

<script>
document.getElementById('addSupplierForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('{% url "dashboard:add_supplier" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      showNotification('Pemasok berhasil ditambahkan!', 'success');
      document.getElementById('addSupplierModal').querySelector('.btn-close').click();
      setTimeout(() => location.reload(), 2000);
    } else {
      showNotification('Terjadi kesalahan saat menambahkan pemasok.', 'error');
    }
  });
});

document.addEventListener('DOMContentLoaded', function() {
  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.classList.add('show');
    }, 100);

    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // Edit Supplier Functionality
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const name = this.getAttribute('data-name');
      const contact = this.getAttribute('data-contact');
      const email = this.getAttribute('data-email');
      const city = this.getAttribute('data-city');
      const address = this.getAttribute('data-address');

      document.getElementById('edit_id_supplier').value = id;
      document.getElementById('edit_name_supplier').value = name;
      document.getElementById('edit_contact_supplier').value = contact;
      document.getElementById('edit_email_supplier').value = email;
      document.getElementById('edit_city_supplier').value = city;
      document.getElementById('edit_address_supplier').value = address;

      const modal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
      modal.show();
    });
  });

  // Delete Supplier Functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const name = this.getAttribute('data-name');

      document.getElementById('delete_supplier_id').textContent = id;
      document.getElementById('delete_supplier_name').textContent = name;

      const modal = new bootstrap.Modal(document.getElementById('deleteSupplierModal'));
      modal.show();

      document.getElementById('confirmDeleteSupplierBtn').onclick = function() {
        fetch('{% url "dashboard:delete_supplier" %}', {
          method: 'POST',
          body: JSON.stringify({ id: id }),
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            showNotification('Pemasok berhasil dihapus!', 'success');
            const modalElement = document.getElementById('deleteSupplierModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            setTimeout(() => location.reload(), 2000);
          } else {
            showNotification('Terjadi kesalahan saat menghapus pemasok.', 'error');
          }
        });
      };
    });
  });

  // Edit Supplier Form Submission
  document.getElementById('editSupplierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('{% url "dashboard:edit_supplier" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification('Pemasok berhasil diperbarui!', 'success');
        const modalElement = document.getElementById('editSupplierModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        setTimeout(() => location.reload(), 2000);
      } else {
        showNotification('Terjadi kesalahan saat memperbarui pemasok.', 'error');
      }
    });
  });
});
</script>

<!-- Notification Styles -->
<style>
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 5px;
  color: white;
  font-weight: bold;
  z-index: 9999;
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.3s ease;
}

.notification.show {
  opacity: 1;
  transform: translateX(0);
}

.notification.success {
  background-color: #28a745;
}

.notification.error {
  background-color: #dc3545;
}
</style>
